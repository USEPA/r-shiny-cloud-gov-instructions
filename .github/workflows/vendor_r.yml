on:
  workflow_dispatch:

jobs:
  download_and_vendor_dependencies:
    runs-on: ubuntu-latest
  
    steps:
    - uses: actions/checkout@v3

    # - name: Delete existing vendor_r
    #   run: |
    #     if [ -d "vendor_r" ]; then rm -fr vendor_r; fi

    - name: Setup R
      uses: r-lib/actions/setup-r@v2

    - name: Download dependency
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        packages: stringr

    - name: List R dependencies
      run: |
        sed -n -e 's/^.*- name: //p' r.yml | sed -n -e 'H;${x;s/\n/,/g;s/^,//;p;}' | xargs echo packs= >> $GITHUB_ENV

    - name: Download R packages
      run: |
        Rscript .github/scripts/download_packages.R vendor_r/src/contrib ${{ env.packs }}

    - run: ls -R

    - name: Write Descriptions
      run: |
        mkdir temp
        export TMPDIR=temp
        chmod +x .github/scripts/write_descriptions.sh
        .github/scripts/write_descriptions.sh vendor_r/src/contrib/

    - name: Commit & Push
      if: ${{ success() }}
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add vendor_r
        git commit -m "Automated workflow from GitHub Actions to vendor R dependencies"
        git push